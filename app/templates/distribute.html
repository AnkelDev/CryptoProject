{% extends 'base.html' %}
{% block content %}
<section class="card distribution-card">
  <h2>‚öñÔ∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤</h2>
  <p class="subtitle">–£–ø—Ä–∞–≤–ª—è–π –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –∏ –±–∞–ª–∞–Ω—Å–æ–º –≤ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–π LOTOS-–ø–∞–Ω–µ–ª–∏.</p>

  <!-- –ü–∞–Ω–µ–ª—å –±–∞–ª–∞–Ω—Å–∞ -->
  <div class="wallet-dashboard">
    <div class="wallet-balance">
      <div class="circle">
        <span id="wallet_balance">--</span>
        <small>SOL</small>
      </div>
      <div class="wallet-info" id="wallet_info">
        –ë–∞–ª–∞–Ω—Å: -- SOL ‚âà -- USD
      </div>
      <button id="btn_balance" class="btn violet">üí∞ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    </div>

    <div class="wallet-list">
      <h3>–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏</h3>
      <ul id="wallets_list">
        <li class="empty">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</li>
      </ul>
    </div>
  </div>

  <hr />

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <button id="toggle_wallet_settings" class="wallet-btn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞</button>
  <div id="wallet_settings" class="wallet-settings hidden">
    <div class="field">
      <label for="pubkey">–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</label>
      <input id="pubkey" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è" />
    </div>
    <div class="field">
      <label for="private_key">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á</label>
      <input id="private_key" type="password" placeholder="base58 secret" />
    </div>
  </div>

  <hr />

  <!-- –§–æ—Ä–º–∞ -->
  <div class="form-grid">
    <label for="recipients">–°–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</label>
    <textarea id="recipients" rows="6" placeholder="–û–¥–∏–Ω –∞–¥—Ä–µ—Å –Ω–∞ —Å—Ç—Ä–æ–∫—É"></textarea>

    <div class="row">
      <label>–†–∞–≤–Ω—ã–µ –¥–æ–ª–∏</label>
      <div class="toggle" id="equal_toggle" data-on="true"></div>
    </div>

    <div class="row">
      <label>–°–ø–∏—Å–∞—Ç—å –≤–µ—Å—å –±–∞–ª–∞–Ω—Å</label>
      <input type="checkbox" id="send_all" />
    </div>

    <label for="total_sol">–û–±—â–∞—è —Å—É–º–º–∞ SOL</label>
    <input id="total_sol" type="number" step="0.0001" placeholder="–ï—Å–ª–∏ –Ω–µ —Ä–∞–≤–Ω—ã–µ –¥–æ–ª–∏" />

    <div class="buttons">
      <button id="btn_estimate" class="btn soft">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
      <button id="btn_send" class="btn glow">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div class="results">
    <div id="plan" class="plan"></div>
    <div id="log" class="log"></div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("toggle_wallet_settings");
  const settings = document.getElementById("wallet_settings");
  const toggle = document.getElementById("equal_toggle");
  const sendAll = document.getElementById("send_all");
  const recipients = document.getElementById("recipients");
  const walletsList = document.getElementById("wallets_list");
  const balanceEl = document.getElementById("wallet_balance");
  const walletInfo = document.getElementById("wallet_info");
  const plan = document.getElementById("plan");
  const log = document.getElementById("log");

  async function postJSON(url, data) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || "–û—à–∏–±–∫–∞");
    return json;
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ ---
  document.getElementById("btn_balance").addEventListener("click", async () => {
    const pubkey = document.getElementById("pubkey").value.trim();
    if (!pubkey) return alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è!");
    try {
      walletInfo.textContent = "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å...";
      const data = await postJSON("/api/balance", { pubkey });
      const sol = data.balance_sol;

      const priceRes = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd");
      const priceData = await priceRes.json();
      const usd = (sol * priceData.solana.usd).toFixed(2);

      balanceEl.textContent = sol.toFixed(4);
      walletInfo.textContent = `–ë–∞–ª–∞–Ω—Å: ${sol.toFixed(4)} SOL ‚âà ${usd} USD`;
    } catch (err) {
      walletInfo.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞";
      alert("–û—à–∏–±–∫–∞: " + err.message);
    }
  });

  // --- –†–∞—Å—á—ë—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ---
  document.getElementById("btn_estimate").addEventListener("click", async () => {
    const pubkey = document.getElementById("pubkey").value.trim();
    if (!pubkey) return alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è!");

    try {
      plan.innerHTML = `<div class="loading">‚è≥ –†–∞—Å—á—ë—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è...</div>`;
      const data = await postJSON("/api/estimate", {
        pubkey,
        recipients: recipients.value,
        equal_shares: toggle.dataset.on === "true",
        send_all: sendAll.checked,
        total_sol: parseFloat(document.getElementById("total_sol").value || 0),
      });

      const p = data.plan;
      let html = `
        <div class="summary-block">
          <h3>üìä –ü–ª–∞–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</h3>
          <p><b>–ë–∞–ª–∞–Ω—Å:</b> ${p.balance_sol.toFixed(4)} SOL</p>
          <p><b>–û–±—â–∞—è —Å—É–º–º–∞:</b> ${p.required_distribution_sol.toFixed(4)} SOL</p>
          <p><b>–ö–æ–º–∏—Å—Å–∏—è:</b> ${p.estimated_fees_sol.toFixed(6)} SOL</p>
          <p><b>–ò—Ç–æ–≥–æ:</b> ${p.required_total_sol.toFixed(4)} SOL ‚âà ${(p.required_total_usd).toFixed(2)} USD</p>
          <p class="rate">üí± 1 SOL = ${p.usd_per_sol.toFixed(2)} USD</p>
        </div>
        <h3>üì¨ –ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h3>
        <table class="balances-table">
          <tr><th>–ê–¥—Ä–µ—Å</th><th>–ë–∞–ª–∞–Ω—Å (SOL)</th><th>–ü–µ—Ä–µ–≤–æ–¥ (SOL)</th></tr>
          ${p.recipients.map((r, i) => {
            const bal = p.recipients_balances?.[i]?.balance_sol ?? "‚Äî";
            return `
              <tr>
                <td><code>${r.address}</code></td>
                <td>${typeof bal === "number" ? bal.toFixed(4) : "‚ùå"}</td>
                <td><b>${r.amount_sol.toFixed(4)}</b></td>
              </tr>`;
          }).join("")}
        </table>
      `;
      plan.innerHTML = html;

    } catch (err) {
      plan.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${err.message}</div>`;
    }
  });

  // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ---
  document.getElementById("btn_send").addEventListener("click", async () => {
    const pubkey = document.getElementById("pubkey").value.trim();
    const private_key = document.getElementById("private_key").value.trim();
    if (!pubkey || !private_key) return alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á!");

    try {
      log.innerHTML = `<div class="loading">üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã...</div>`;
      const data = await postJSON("/api/distribute", {
        pubkey,
        private_key_base58: private_key,
        recipients: recipients.value,
        equal_shares: toggle.dataset.on === "true",
        send_all: sendAll.checked,
        total_sol: parseFloat(document.getElementById("total_sol").value || 0),
        admin_token: "changeme"
      });

      const r = data.result;
      let html = `
        <h3>üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h3>
        <table class="balances-table">
          <tr><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>Tx (—Å–∏–≥–Ω–∞—Ç—É—Ä–∞)</th></tr>
          ${r.results.map(res => `
            <tr>
              <td><code>${res.to}</code></td>
              <td>${res.status === "ok" ? "‚úÖ –£—Å–ø–µ—à–Ω–æ" : res.status === "skipped" ? "‚ö† –ü—Ä–æ–ø—É—â–µ–Ω–æ" : "‚ùå –û—à–∏–±–∫–∞"}</td>
              <td>${res.tx ? `<a href="https://solscan.io/tx/${res.tx}" target="_blank">${res.tx.slice(0, 8)}...</a>` : "‚Äî"}</td>
            </tr>`).join("")}
        </table>
      `;
      log.innerHTML = html;

    } catch (err) {
      log.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${err.message}</div>`;
    }
  });

  // --- UI –ª–æ–≥–∏–∫–∞ ---
  btn.addEventListener("click", () => {
    settings.classList.toggle("visible");
    btn.textContent = settings.classList.contains("visible")
      ? "üîí –°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
      : "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞";
  });

  toggle.addEventListener("click", () => {
    const on = toggle.dataset.on === "true";
    toggle.dataset.on = !on;
    toggle.classList.toggle("off");
  });

  sendAll.addEventListener("change", (e) => {
    document.getElementById("total_sol").disabled = e.target.checked;
  });

  recipients.addEventListener("blur", () => {
    const rec = recipients.value.trim().split("\n").filter(r => r);
    walletsList.innerHTML = rec.length
      ? rec.map(a => `<li>${a}</li>`).join("")
      : `<li class="empty">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</li>`;
  });
});
</script>
{% endblock %}
